# 各指標の詳細

DORA Four Key Metricsの各指標について、公式定義、パフォーマンス分類、本プロジェクトでの実装方法を解説します。

## 目次

- [1. Deployment Frequency（デプロイ頻度）](#1-deployment-frequencyデプロイ頻度)
- [2. Lead Time for Changes（変更のリードタイム）](#2-lead-time-for-changes変更のリードタイム)
- [3. Change Failure Rate（変更失敗率）](#3-change-failure-rate変更失敗率)
- [4. Mean Time to Recovery / MTTR（平均復旧時間）](#4-mean-time-to-recovery--mttr平均復旧時間)

---

## 1. Deployment Frequency（デプロイ頻度）

### 公式定義

> 組織が本番環境またはエンドユーザーへのリリースを成功させる頻度

### パフォーマンス分類（DORA基準）

| レベル | 頻度 |
|--------|------|
| Elite | オンデマンド（1日複数回） |
| High | 1日1回〜週1回 |
| Medium | 週1回〜月1回 |
| Low | 月1回〜6ヶ月に1回 |

### 本プロジェクトでの実装

```
計算式: 成功デプロイ数 / 期間（日数）
```

**データソース（優先順位）:**

1. **GitHub Deployments API** - `production`環境への成功デプロイをカウント
2. **フォールバック: GitHub Actions** - ワークフロー名に「deploy」を含む成功した実行をカウント

**分類基準:**
- `daily`: 1日1回以上
- `weekly`: 週1回以上
- `monthly`: 月1回以上
- `yearly`: 月1回未満

### 制約事項

- GitHub Deployments APIを使用していないプロジェクトでは、ワークフロー名ベースのヒューリスティックに依存
- 環境名は設定で変更可能（デフォルト: `production`）

---

## 2. Lead Time for Changes（変更のリードタイム）

### 公式定義

> コードがコミットされてから本番環境で正常に稼働するまでの時間

DORAの定義では、最初のコミットから本番デプロイまでの時間を測定しますが、実際の計測ではPRのオープンからデプロイまでの時間が一般的に使用されます。

### パフォーマンス分類（DORA基準）

| レベル | リードタイム |
|--------|-------------|
| Elite | 1時間未満 |
| High | 1日〜1週間 |
| Medium | 1週間〜1ヶ月 |
| Low | 1ヶ月以上 |

> **実装上の注意**: DORA公式定義では1時間〜1日の間が未定義です。
> 本実装では連続的に分類するため、この範囲をHighとして扱っています。
> 詳細は `src/config/doraThresholds.ts` を参照してください。

### 本プロジェクトでの実装

**計算方法（2段階）:**

1. **マージ→デプロイ時間**（推奨）
   - PRがマージされた時刻を取得
   - マージ後24時間以内の最初の成功デプロイを探す
   - 差分を計算

2. **フォールバック: PR作成→マージ時間**
   - デプロイメントデータがない場合に使用
   - PRの作成時刻からマージ時刻までの時間

**出力データ:**
```typescript
{
  leadTimeForChangesHours: 2.5,        // 平均リードタイム（時間）
  leadTimeMeasurement: {
    mergeToDeployCount: 8,             // マージ→デプロイで計測されたPR数
    createToMergeCount: 2,             // フォールバックで計測されたPR数
  }
}
```

### 制約事項

- **時間ベースマッチング**: 理想的にはコミットSHAでPRとデプロイを関連付けるべきですが、GitHub Deployments APIの制約により、時間ベースで近似しています
- **24時間閾値**: マージ後24時間以内のデプロイのみを関連付け。それ以上経過した場合はフォールバックを使用
- フォールバック計測はコードレビュー時間を含むため、純粋なリードタイムより長くなる傾向

---

## 3. Change Failure Rate（変更失敗率）

### 公式定義

> 本番環境へのデプロイのうち、障害（サービス低下、サービス停止、ロールバックが必要な状態）を引き起こした割合

### パフォーマンス分類（DORA基準）

| レベル | 失敗率 |
|--------|--------|
| Elite | 0-15% |
| High | 0-15% |
| Medium | 16-30% |
| Low | 30%超 |

> **注意**: EliteとHighは同じ閾値（0-15%）です。CFRだけでなく他の指標も含めた総合評価でレベルが決まります。

### 本プロジェクトでの実装

```
計算式: 失敗デプロイ数 / 全デプロイ数 × 100
```

**データソース（優先順位）:**

1. **GitHub Deployments API** - ステータスが`failure`または`error`のデプロイをカウント
2. **フォールバック: GitHub Actions** - `conclusion`が`failure`のデプロイワークフローをカウント

### 重要な注意事項

> **⚠️ 真のDORA定義との差異**
>
> DORAの公式定義では、**本番環境でインシデントを引き起こしたデプロイ**を測定します。これには以下が含まれます:
> - ユーザーに影響を与えた障害
> - ロールバックが必要になったデプロイ
> - ホットフィックスが必要になった変更
>
> 本実装では、**CI/CDパイプラインの失敗率**を測定しており、これは近似値です。真のChange Failure Rateを測定するには、インシデント管理システム（PagerDuty、Opsgenie等）との連携が必要です。

### 制約事項

- デプロイ自体は成功したが、その後本番で問題が発生したケースは検出できない
- `skipStatusFetch=true`の場合、全デプロイのステータスが`null`となりワークフローにフォールバック

---

## 4. Mean Time to Recovery / MTTR（平均復旧時間）

### 公式定義

> 本番環境でサービス障害が発生してから復旧するまでの時間

### パフォーマンス分類（DORA基準）

| レベル | 復旧時間 |
|--------|----------|
| Elite | 1時間未満 |
| High | 1日未満 |
| Medium | 1週間未満 |
| Low | 1週間以上 |

### 本プロジェクトでの実装

本プロジェクトでは、MTTRを2つの方式で計測できます:

#### 方式1: CI/CD方式（デフォルト）

デプロイの失敗から次の成功デプロイまでの時間を測定します。

```
計算式: Σ(復旧デプロイ時刻 - 障害デプロイ時刻) / 障害回数
```

**計算ロジック:**

1. デプロイを時系列順にソート
2. 失敗デプロイ（`status = failure` または `error`）を検出
3. その後の最初の成功デプロイまでの時間を計算
4. 全復旧時間の平均を算出

**データソース（優先順位）:**

1. **GitHub Deployments API** - `failure`/`error`から`success`までの時間
2. **フォールバック: GitHub Actions** - デプロイワークフローの失敗から成功までの時間

**出力フィールド**: `meanTimeToRecoveryHours`

#### 方式2: インシデント方式（推奨）

GitHub Issuesをインシデントトラッキングとして使用し、真のDORA定義に近いMTTRを測定します。

```
計算式: Σ(Issue close時刻 - Issue作成時刻) / クローズ済みインシデント数
```

**計算ロジック:**

1. 指定ラベル（デフォルト: `incident`）が付いたIssueを取得
2. クローズ済みのIssueを抽出
3. 各Issueの作成時刻からクローズ時刻までの時間を計算
4. 全復旧時間の平均を算出

**出力フィールド**: `incidentMetrics.mttrHours`

**追加の出力情報**:
```typescript
incidentMetrics: {
  incidentCount: 5,      // 期間内のインシデント総数
  openIncidents: 1,      // 未解決のインシデント数
  mttrHours: 2.3         // 平均復旧時間（時間）
}
```

### 2つの方式の比較

| 項目 | CI/CD方式 | インシデント方式 |
|------|-----------|-----------------|
| 測定対象 | デプロイ失敗 | 本番インシデント |
| 検出方法 | 自動（デプロイステータス） | 手動（Issue作成） |
| DORA定義との一致度 | 近似値 | より正確 |
| 設定の手間 | なし | ラベル設定が必要 |
| 運用フロー | 既存のまま | インシデント時にIssue作成が必要 |

**推奨**: 両方の値を出力し、チームの運用に合わせて使い分けることを推奨します。

### 重要な注意事項

> **⚠️ CI/CD方式の制約**
>
> CI/CD方式は**デプロイ失敗から次の成功デプロイまでの時間**を測定します。これは:
> - デプロイは成功したが、後から本番で問題が発生したケースを検出できない
> - 本番環境の実際のダウンタイムではなく、デプロイ間の時間を測定
>
> 真のMTTRを測定するには、インシデント方式の使用を推奨します。

### 制約事項

**CI/CD方式:**
- 未復旧の障害（期間内に成功デプロイがない）はカウントされない
- 障害がない場合は`null`を返す
- 本番環境の実際のダウンタイムではなく、デプロイ間の時間を測定

**インシデント方式:**
- 運用チームがインシデント発生時にIssueを作成する必要がある
- Issue作成のタイミングが障害検知時刻として使用される
- Issueをクローズし忘れると未解決としてカウントされる
